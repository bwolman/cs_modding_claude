<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Localization System - CS2 Modding Research</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="top-bar">
  <a href="index.html" class="site-title">CS2 Modding Research</a>
  <span class="attribution">Generated with Claude | Supervised by repository owner</span>
</div>

<div class="page-layout">

    <aside class="sidebar">
    <h3>Events &amp; Simulation</h3>
    <a href="event-entity-archetype.html">Event Entity Archetype</a>
    <a href="fire-ignition.html">Fire Ignition</a>
    <a href="vehicle-out-of-control.html">Vehicle Accidents</a>
    <a href="crime-trigger.html">Crime Trigger</a>
    <a href="citizen-sickness.html">Citizen Sickness</a>
    <a href="water-system.html">Water System</a>
    <a href="emergency-dispatch.html">Emergency Dispatch</a>
    <a href="disaster-simulation.html">Disaster Simulation</a>

    <h3>Infrastructure</h3>
    <a href="electricity-grid.html">Electricity Grid</a>
    <a href="water-sewage-pipes.html">Water &amp; Sewage Pipes</a>
    <a href="road-network.html">Road &amp; Network Building</a>
    <a href="zoning.html">Zoning</a>
    <a href="pathfinding.html">Pathfinding</a>
    <a href="traffic-flow.html">Traffic Flow</a>

    <h3>Economy &amp; Population</h3>
    <a href="citizens-households.html">Citizens &amp; Households</a>
    <a href="economy-budget.html">Economy &amp; Budget</a>
    <a href="demand-systems.html">Demand Systems</a>
    <a href="resource-production.html">Resource Production</a>
    <a href="company-simulation.html">Company Simulation</a>
    <a href="workplace-labor.html">Workplace &amp; Labor</a>
    <a href="land-value-property.html">Land Value &amp; Property</a>
    <a href="trade-connections.html">Trade &amp; Connections</a>
    <a href="tourism-economy.html">Tourism Economy</a>
    <a href="cargo-transport.html">Cargo Transport</a>

    <h3>City Services</h3>
    <a href="garbage-collection.html">Garbage Collection</a>
    <a href="education.html">Education</a>
    <a href="public-transit.html">Public Transit</a>
    <a href="healthcare.html">Healthcare</a>
    <a href="deathcare.html">Deathcare</a>
    <a href="parks-recreation.html">Parks &amp; Recreation</a>
    <a href="police-dispatch.html">Police Dispatch</a>

    <h3>Governance</h3>
    <a href="districts-policies.html">Districts &amp; Policies</a>
    <a href="map-tile-purchase.html">Map Tile Purchase</a>

    <h3>Environment</h3>
    <a href="weather-climate.html">Weather &amp; Climate</a>
    <a href="pollution.html">Pollution</a>
    <a href="terrain-resources.html">Terrain &amp; Resources</a>

    <h3>Vehicles &amp; Transport</h3>
    <a href="vehicle-spawning.html">Vehicle Spawning</a>

    <h3>Tools &amp; Input</h3>
    <a href="tool-activation.html">Tool Activation</a>
    <a href="tool-raycast.html">Tool Raycast</a>
    <a href="input-action-lifecycle.html">Input Action Lifecycle</a>
    <a href="mod-hotkey-input.html">Mod Hotkey Input</a>
    <a href="object-tool-system.html">Object Placement Tool</a>

    <h3>UI &amp; Settings</h3>
    <a href="mod-ui-buttons.html">Mod UI Buttons</a>
    <a href="mod-options-ui.html">Mod Options UI</a>
    <a href="info-views-overlays.html">Info Views &amp; Overlays</a>
    <a href="chirper-notifications.html">Chirper Notifications</a>

    <h3>Modding Framework</h3>
    <a href="save-load-persistence.html">Save/Load Persistence</a>
    <a href="prefab-system.html">Prefab System</a>
    <a href="localization.html" class="active">Localization</a>
    <a href="harmony-transpilers.html">Harmony Transpilers</a>
    <a href="mod-loading-dependencies.html">Mod Loading</a>
  </aside>

  <main class="content">

  <h1>Localization System</h1>

  <div class="scope">
    <h2>Scope</h2>
    <p>
      <strong>Question:</strong> How does CS2's localization pipeline load and resolve
      translated strings, and how do mods add their own localized text?
    </p>
    <p>
      <strong>Verdict:</strong> CS2 uses a <strong>source-based dictionary system</strong>.
      <code>LocalizationManager</code> maintains per-locale dictionaries populated by
      <code>IDictionarySource</code> implementations. Mods add strings via
      <code>MemorySource</code> (an in-memory dictionary wrapper). The system supports
      fallback locales, indexed entries, and parameterized substitutions through
      <code>LocalizedString</code>.
    </p>
  </div>

  <h2>How It Works</h2>

  <div class="diagram"><pre>
[Locale assets loaded from AssetDatabase]
        |
[LocalizationManager.LoadAvailableLocales()]
  - Finds all LocaleAsset objects
  - Calls AddLocale() and AddSourceInternal() for each
        |
[Mod calls AddSource("en-US", new MemorySource(dict))]
  - Source added to m_UserSources list
  - If locale matches active: entries loaded into activeDictionary
  - If locale matches fallback: merged into fallback dictionary
        |
[UI requests a string]
  - activeDictionary.TryGetValue(entryID, out value)
  - Fallback entries used if not found in active locale
  - LocalizedString sent to UI with id/value/args
  </pre></div>

  <h2>Key Components</h2>

  <h3>LocalizationManager</h3>
  <p>Central manager for all localization data. Maintains dictionaries per locale.</p>
  <table>
    <thead><tr><th>Method</th><th>Description</th></tr></thead>
    <tbody>
      <tr><td><code>AddSource(localeId, source)</code></td><td>Add a dictionary source for a locale</td></tr>
      <tr><td><code>RemoveSource(localeId, source)</code></td><td>Remove a dictionary source</td></tr>
      <tr><td><code>SetActiveLocale(localeId)</code></td><td>Switch the active language</td></tr>
      <tr><td><code>GetSupportedLocales()</code></td><td>List all registered locale IDs</td></tr>
      <tr><td><code>ReloadActiveLocale()</code></td><td>Clear and reload current locale</td></tr>
    </tbody>
  </table>

  <h3>LocalizationDictionary</h3>
  <p>String lookup dictionary for a single locale. Simple key-value store with fallback tracking.</p>
  <table>
    <thead><tr><th>Method</th><th>Description</th></tr></thead>
    <tbody>
      <tr><td><code>TryGetValue(entryID, out value)</code></td><td>Lookup a string by ID</td></tr>
      <tr><td><code>ContainsID(entryID)</code></td><td>Check if an ID exists</td></tr>
      <tr><td><code>Add(entryID, value)</code></td><td>Add or replace an entry</td></tr>
      <tr><td><code>MergeFrom(other, fallback)</code></td><td>Merge entries from another dictionary</td></tr>
    </tbody>
  </table>

  <h3>IDictionarySource</h3>
  <p>Interface for providing localization entries.</p>
  <pre><code>public interface IDictionarySource
{
    IEnumerable&lt;KeyValuePair&lt;string, string&gt;&gt; ReadEntries(
        IList&lt;IDictionaryEntryError&gt; errors,
        Dictionary&lt;string, int&gt; indexCounts);
    void Unload();
}</code></pre>

  <h3>MemorySource</h3>
  <p>Simple in-memory implementation of <code>IDictionarySource</code>. Wraps a <code>Dictionary&lt;string, string&gt;</code>. This is what mods use to inject strings.</p>

  <h3>LocalizedString</h3>
  <p>Readonly struct used in UI bindings to reference localized text.</p>
  <table>
    <thead><tr><th>Factory Method</th><th>Description</th></tr></thead>
    <tbody>
      <tr><td><code>LocalizedString.Id(id)</code></td><td>Lookup by localization key</td></tr>
      <tr><td><code>LocalizedString.Value(value)</code></td><td>Literal text (no lookup)</td></tr>
      <tr><td><code>LocalizedString.IdWithFallback(id, value)</code></td><td>ID with fallback value</td></tr>
      <tr><td><code>LocalizedString.IdHash&lt;T&gt;(id, hash)</code></td><td>ID with enum hash suffix</td></tr>
    </tbody>
  </table>

  <h2>String ID Convention</h2>

  <pre><code>// Prefab names (square brackets, NOT colon)
Assets.NAME[PrefabName]
Assets.DESCRIPTION[PrefabName]

// Settings
Options.SECTION[ModName.ModName.Mod]:Setting.DisplayName
Options.SECTION[ModName.ModName.Mod]:Setting.Description

// UI elements
Menu.TITLE[SomeTool]
ToolOptions.TOOLTIP[SomeOption]

// Indexed entries (colon + index)
SubServices.NAME:0
SubServices.NAME:1</code></pre>

  <h2>Examples</h2>

  <h3>Example 1: Adding Mod Strings</h3>
  <pre><code>public void AddLocalization(LocalizationManager manager)
{
    var strings = new Dictionary&lt;string, string&gt;
    {
        { "MyMod.Title", "My Custom Mod" },
        { "MyMod.Description", "This mod adds cool features" },
        { "MyMod.Setting.Enabled", "Enable Feature" },
        { "MyMod.Setting.Enabled.Desc", "Toggle the main feature on or off" }
    };

    manager.AddSource("en-US", new MemorySource(strings));
}</code></pre>

  <h3>Example 2: Supporting Multiple Languages</h3>
  <pre><code>public void AddMultiLanguageStrings(LocalizationManager manager)
{
    manager.AddSource("en-US", new MemorySource(
        new Dictionary&lt;string, string&gt;
        {
            { "MyMod.Title", "My Custom Mod" },
            { "MyMod.Greeting", "Hello, Mayor!" }
        }));

    manager.AddSource("de-DE", new MemorySource(
        new Dictionary&lt;string, string&gt;
        {
            { "MyMod.Title", "Mein benutzerdefinierter Mod" },
            { "MyMod.Greeting", "Hallo, Buergermeister!" }
        }));
}</code></pre>

  <h3>Example 3: Looking Up a String</h3>
  <pre><code>var dictionary = GameManager.instance.localizationManager.activeDictionary;
if (dictionary.TryGetValue("MyMod.Title", out string title))
{
    // Use title
}</code></pre>

  <h3>Example 4: Using LocalizedString in UI Bindings</h3>
  <pre><code>// ID-only (resolved by the UI)
LocalizedString label = LocalizedString.Id("MyMod.Title");

// With substitution parameters
LocalizedString greeting = LocalizedString.Id("MyMod.Welcome",
    ("PLAYER_NAME", LocalizedString.Value("Mayor")));

// Literal value (no localization lookup)
LocalizedString literal = LocalizedString.Value("Fixed text");

// ID with fallback
LocalizedString safe = LocalizedString.IdWithFallback(
    "MyMod.MaybeExists", "Default Text");</code></pre>

  <h2>Custom IDictionarySource Implementation</h2>

  <p>
    Instead of passing a pre-built dictionary to <code>MemorySource</code>, mods can implement
    <code>IDictionarySource</code> directly. This enables dynamic key generation at read time --
    useful when localization keys depend on the mod's settings structure or runtime state.
  </p>

  <pre><code class="language-csharp">using Colossal.Localization;

public class MyModLocaleSource : IDictionarySource
{
    private readonly Setting _setting;

    public MyModLocaleSource(Setting setting)
    {
        _setting = setting;
    }

    public IEnumerable&lt;KeyValuePair&lt;string, string&gt;&gt; ReadEntries(
        IList&lt;IDictionaryEntryError&gt; errors,
        Dictionary&lt;string, int&gt; indexCounts)
    {
        var entries = new List&lt;KeyValuePair&lt;string, string&gt;&gt;();

        // Generate settings UI keys dynamically
        entries.Add(new(_setting.GetSettingsLocaleID(), "My Mod Settings"));

        // Per-option display names and descriptions
        entries.Add(new(
            _setting.GetOptionLabelLocaleID(nameof(Setting.EnableFeature)),
            "Enable Feature"));
        entries.Add(new(
            _setting.GetOptionDescLocaleID(nameof(Setting.EnableFeature)),
            "Toggle the main feature on or off"));

        // Per-tab and per-group labels
        entries.Add(new(
            _setting.GetOptionTabLocaleID(Setting.kGeneralTab), "General"));
        entries.Add(new(
            _setting.GetOptionGroupLocaleID(Setting.kMainGroup), "Main Settings"));

        // Enum value display names
        foreach (var value in Enum.GetValues(typeof(MyEnum)))
        {
            entries.Add(new(
                _setting.GetEnumValueLocaleID((MyEnum)value),
                value.ToString()));
        }

        return entries;
    }

    public void Unload() { }
}

// Registration in Mod.OnLoad():
// var locManager = GameManager.instance.localizationManager;
// locManager.AddSource("en-US", new MyModLocaleSource(settings));</code></pre>

  <p><strong>When to use <code>IDictionarySource</code> vs <code>MemorySource</code>:</strong></p>

  <ul>
    <li>Use <code>MemorySource</code> when you have a static, pre-known set of key-value pairs</li>
    <li>Use a custom <code>IDictionarySource</code> when keys are generated dynamically from the mod's settings structure or runtime state</li>
    <li>Both register the same way via <code>LocalizationManager.AddSource()</code></li>
  </ul>

  <h2>Warnings &amp; Pitfalls</h2>

  <ul>
    <li><strong>Sources are per-locale</strong> -- you must call <code>AddSource()</code> separately for each locale you support.</li>
    <li><strong>Fallback dictionary auto-merges</strong> -- entries added to the fallback locale are automatically available in all other locales (as fallback values).</li>
    <li><strong>User sources persist across reloads</strong> -- <code>m_UserSources</code> is re-applied when <code>LoadAvailableLocales()</code> runs.</li>
    <li><strong>TryGetValue is case-sensitive</strong> -- string IDs use ordinal comparison.</li>
    <li><strong>Duplicate keys overwrite silently</strong> -- the last source to add a key wins.</li>
  </ul>

  <h3>Example 5: Embedded JSON Localization</h3>

  <p>
    Load localization from JSON files embedded as assembly resources. Supports multiple languages
    with graceful fallback.
  </p>

  <pre><code class="language-csharp">var assembly = Assembly.GetExecutingAssembly();
var supportedLocales = GameManager.instance.localizationManager.GetSupportedLocales();

foreach (var locale in supportedLocales)
{
    // Convention: AssemblyName.l10n.localeID.json
    string resourceName = $"{assembly.GetName().Name}.l10n.{locale}.json";

    using var stream = assembly.GetManifestResourceStream(resourceName);
    if (stream == null) continue; // Locale not supported

    using var reader = new StreamReader(stream);
    var dict = JsonSerializer.Deserialize&lt;Dictionary&lt;string, string&gt;&gt;(reader.ReadToEnd());

    GameManager.instance.localizationManager.AddSource(locale, new MemorySource(dict));
}</code></pre>

  <p>
    <strong>Resource naming convention:</strong>
    <code>{AssemblyName}.l10n.{localeID}.json</code> (e.g.,
    <code>TreeController.l10n.en-US.json</code>). The JSON file is a flat object
    mapping string IDs to translated text.
  </p>

  <h3>Example 6: CSV-Based Multi-Locale Localization Loading</h3>

  <p>
    Load localization from a tab-separated embedded resource file with columns for each locale.
    This scales well for mods supporting many languages -- all translations live in a single file.
  </p>

  <p><strong>CSV file format</strong> (<code>Resources/l10n.csv</code>, tab-separated, embedded resource):</p>

  <pre><code>KEY	en-US	de-DE	fr-FR	zh-HANS
MyMod.Title	My Custom Mod	Mein Mod	Mon Mod	&#x6211;&#x7684;&#x6A21;&#x7EC4;
MyMod.Greeting	Hello, Mayor!	Hallo, Buergermeister!	Bonjour, Maire!	&#x4F60;&#x597D;&#xFF0C;&#x5E02;&#x957F;&#xFF01;
MyMod.Setting.Enabled	Enable Feature	Feature aktivieren	Activer la fonctionnalite	&#x542F;&#x7528;&#x529F;&#x80FD;</code></pre>

  <p><strong>Loader implementation:</strong></p>

  <pre><code class="language-csharp">using System.IO;
using System.Reflection;
using Colossal.Localization;

/// &lt;summary&gt;
/// Loads localization from a tab-separated embedded resource file.
/// Each column after the key column corresponds to a locale ID.
/// Creates a MemorySource per supported locale found in the CSV header.
/// &lt;/summary&gt;
public static class CsvLocalizationLoader
{
    public static void Load(LocalizationManager locManager)
    {
        var assembly = Assembly.GetExecutingAssembly();
        string resourceName = $"{assembly.GetName().Name}.Resources.l10n.csv";

        using var stream = assembly.GetManifestResourceStream(resourceName);
        if (stream == null)
        {
            Mod.Log.Warn("Localization CSV not found as embedded resource");
            return;
        }

        using var reader = new StreamReader(stream);

        // Parse header row to get locale column indices
        string headerLine = reader.ReadLine();
        if (headerLine == null) return;
        string[] headers = headerLine.Split('\t');

        var supportedLocales = new HashSet&lt;string&gt;(
            locManager.GetSupportedLocales());

        // Map column index -&gt; locale ID (skip column 0 which is the key)
        var localeColumns = new Dictionary&lt;int, string&gt;();
        for (int i = 1; i &lt; headers.Length; i++)
        {
            string localeId = headers[i].Trim();
            if (supportedLocales.Contains(localeId))
                localeColumns[i] = localeId;
        }

        // Build dictionaries per locale
        var dictionaries = new Dictionary&lt;string, Dictionary&lt;string, string&gt;&gt;();
        foreach (var localeId in localeColumns.Values)
            dictionaries[localeId] = new Dictionary&lt;string, string&gt;();

        // Parse data rows
        string line;
        while ((line = reader.ReadLine()) != null)
        {
            if (string.IsNullOrWhiteSpace(line)) continue;
            string[] columns = line.Split('\t');
            if (columns.Length &lt; 2) continue;

            string key = columns[0].Trim();
            foreach (var (colIndex, localeId) in localeColumns)
            {
                if (colIndex &lt; columns.Length
                    &amp;&amp; !string.IsNullOrEmpty(columns[colIndex]))
                    dictionaries[localeId][key] = columns[colIndex];
            }
        }

        // Register a MemorySource per locale
        foreach (var (localeId, dict) in dictionaries)
        {
            if (dict.Count &gt; 0)
            {
                locManager.AddSource(localeId, new MemorySource(dict));
                Mod.Log.Info($"Loaded {dict.Count} entries for {localeId}");
            }
        }
    }
}

// Call in Mod.OnLoad():
// CsvLocalizationLoader.Load(GameManager.instance.localizationManager);</code></pre>

  <p><strong>Embedding the CSV in .csproj:</strong></p>

  <pre><code class="language-xml">&lt;ItemGroup&gt;
    &lt;EmbeddedResource Include="Resources\l10n.csv" /&gt;
&lt;/ItemGroup&gt;</code></pre>

  <p>
    <strong>Loading embedded resources:</strong>
    <code>Assembly.GetManifestResourceStream()</code> expects the full resource name in the format
    <code>{AssemblyName}.{FolderPath}.{FileName}</code> where folder separators are replaced with dots.
    For example, <code>Resources/l10n.csv</code> in assembly <code>MyMod</code> becomes
    <code>MyMod.Resources.l10n.csv</code>.
  </p>

  <h2>JavaScript-Side Translation Resolution</h2>

  <p>
    When using the low-level cohtml communication pattern (without the React/TypeScript build
    pipeline), JavaScript code can resolve localization keys via <code>engine.translate()</code>:
  </p>

  <pre><code class="language-javascript">// Resolve a localization key to its translated string
var translatedText = engine.translate("MyMod.Title");

// Use in dynamically injected DOM elements
var label = document.createElement('span');
label.textContent = engine.translate("MyMod.Greeting");</code></pre>

  <p>
    <code>engine.translate()</code> queries the same <code>LocalizationDictionary</code> used by the
    C# side. It returns the translated string for the active locale, falling back to the fallback
    locale if the key is not found. This is the cohtml-level equivalent of
    <code>LocalizedString.Id()</code> on the C# side.
  </p>

  <p>
    <strong>Note:</strong> When using the standard TypeScript/React build pipeline, localization is
    typically handled via <code>LocalizedString</code> bindings pushed from C# rather than calling
    <code>engine.translate()</code> directly. The <code>engine.translate()</code> approach is primarily
    useful for raw DOM injection patterns (see ModUIButtons research).
  </p>

  <h2>Harmony Patch Points</h2>

  <h3>Candidate 1: LocalizationManager.AddSource</h3>
  <table>
    <thead><tr><th>Detail</th><th>Value</th></tr></thead>
    <tbody>
      <tr><td>Signature</td><td><code>void AddSource(string localeId, IDictionarySource source)</code></td></tr>
      <tr><td>Patch type</td><td>Postfix</td></tr>
      <tr><td>What it enables</td><td>Monitor when sources are added, inject additional entries</td></tr>
      <tr><td>Risk level</td><td>Low</td></tr>
    </tbody>
  </table>

  <h3>Candidate 2: LocalizationDictionary.TryGetValue</h3>
  <table>
    <thead><tr><th>Detail</th><th>Value</th></tr></thead>
    <tbody>
      <tr><td>Signature</td><td><code>bool TryGetValue(string entryID, out string value)</code></td></tr>
      <tr><td>Patch type</td><td>Postfix</td></tr>
      <tr><td>What it enables</td><td>Override specific string lookups dynamically</td></tr>
      <tr><td>Risk level</td><td>High (called very frequently)</td></tr>
    </tbody>
  </table>

  <h2>Mod Blueprint</h2>

  <ul>
    <li><strong>To add localized strings:</strong> Create a <code>MemorySource</code> with a
    <code>Dictionary&lt;string, string&gt;</code> and call
    <code>LocalizationManager.AddSource("en-US", source)</code> for each supported locale.</li>
    <li><strong>To support multiple languages:</strong> Create separate <code>MemorySource</code>
    instances per locale, each with the same keys but translated values.</li>
    <li><strong>Access:</strong> Get the manager via
    <code>GameManager.instance.localizationManager</code>.</li>
  </ul>

  <h2>Open Questions</h2>

  <ul>
    <li>How does the UI template engine resolve <code>ILocElement</code> arguments in format strings?</li>
    <li>How are indexed entries used in practice?</li>
    <li>How does <code>UILocalizationManager</code> bridge between <code>LocalizationManager</code> and the Cohtml UI layer?</li>
    <li>What is the complete set of locale IDs supported by the base game?</li>
  </ul>

  <h2>Sources</h2>

  <ul>
    <li>Decompiled from Colossal.Localization.dll and Game.dll (Cities: Skylines II)</li>
    <li>Key types: LocalizationManager, LocalizationDictionary, MemorySource, IDictionarySource, LocalizedString</li>
  </ul>

  </main>

</div>

<footer>
  <p>Research decompiled from Cities: Skylines II game assemblies using ilspycmd. For educational and modding purposes.</p>
  <div class="attribution-footer">
    <p>This documentation was generated using Claude (Anthropic), supervised by the repository owner.</p>
  </div>
</footer>

</body>
</html>
