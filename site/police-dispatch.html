<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Police Dispatch with Lights &amp; Sirens - CS2 Modding Research</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="top-bar">
  <a href="index.html" class="site-title">CS2 Modding Research</a>
  <span class="attribution">Generated with Claude | Supervised by repository owner</span>
</div>

<div class="page-layout">

    <aside class="sidebar">
    <h3>Events &amp; Simulation</h3>
    <a href="event-entity-archetype.html">Event Entity Archetype</a>
    <a href="fire-ignition.html">Fire Ignition</a>
    <a href="vehicle-out-of-control.html">Vehicle Accidents</a>
    <a href="crime-trigger.html">Crime Trigger</a>
    <a href="citizen-sickness.html">Citizen Sickness</a>
    <a href="water-system.html">Water System</a>
    <a href="emergency-dispatch.html">Emergency Dispatch</a>
    <a href="disaster-simulation.html">Disaster Simulation</a>

    <h3>Infrastructure</h3>
    <a href="electricity-grid.html">Electricity Grid</a>
    <a href="water-sewage-pipes.html">Water &amp; Sewage Pipes</a>
    <a href="road-network.html">Road &amp; Network Building</a>
    <a href="zoning.html">Zoning</a>
    <a href="building-construction.html">Building Construction</a>
    <a href="pathfinding.html">Pathfinding</a>
    <a href="traffic-flow.html">Traffic Flow</a>

    <h3>Economy &amp; Population</h3>
    <a href="citizens-households.html">Citizens &amp; Households</a>
    <a href="economy-budget.html">Economy &amp; Budget</a>
    <a href="demand-systems.html">Demand Systems</a>
    <a href="resource-production.html">Resource Production</a>
    <a href="company-simulation.html">Company Simulation</a>
    <a href="workplace-labor.html">Workplace &amp; Labor</a>
    <a href="land-value-property.html">Land Value &amp; Property</a>
    <a href="trade-connections.html">Trade &amp; Connections</a>
    <a href="tourism-economy.html">Tourism Economy</a>
    <a href="cargo-transport.html">Cargo Transport</a>

    <h3>City Services</h3>
    <a href="garbage-collection.html">Garbage Collection</a>
    <a href="education.html">Education</a>
    <a href="public-transit.html">Public Transit</a>
    <a href="healthcare.html">Healthcare</a>
    <a href="deathcare.html">Deathcare</a>
    <a href="parks-recreation.html">Parks &amp; Recreation</a>
    <a href="police-dispatch.html" class="active">Police Dispatch</a>

    <h3>Governance</h3>
    <a href="districts-policies.html">Districts &amp; Policies</a>
    <a href="map-tile-purchase.html">Map Tile Purchase</a>

    <h3>Environment</h3>
    <a href="weather-climate.html">Weather &amp; Climate</a>
    <a href="pollution.html">Pollution</a>
    <a href="terrain-resources.html">Terrain &amp; Resources</a>

    <h3>Vehicles &amp; Transport</h3>
    <a href="vehicle-spawning.html">Vehicle Spawning</a>
    <a href="parking-system.html">Parking System</a>

    <h3>Tools &amp; Input</h3>
    <a href="tool-activation.html">Tool Activation</a>
    <a href="tool-raycast.html">Tool Raycast</a>
    <a href="input-action-lifecycle.html">Input Action Lifecycle</a>
    <a href="mod-hotkey-input.html">Mod Hotkey Input</a>
    <a href="object-tool-system.html">Object Placement Tool</a>

    <h3>UI &amp; Settings</h3>
    <a href="mod-ui-buttons.html">Mod UI Buttons</a>
    <a href="mod-options-ui.html">Mod Options UI</a>
    <a href="info-views-overlays.html">Info Views &amp; Overlays</a>
    <a href="chirper-notifications.html">Chirper Notifications</a>

    <h3>Modding Framework</h3>
    <a href="save-load-persistence.html">Save/Load Persistence</a>
    <a href="prefab-system.html">Prefab System</a>
    <a href="localization.html">Localization</a>
    <a href="harmony-transpilers.html">Harmony Transpilers</a>
    <a href="mod-loading-dependencies.html">Mod Loading</a>
  </aside>

  <main class="content">

  <h1>Police Dispatch with Lights &amp; Sirens -- Deep Dive</h1>

  <div class="scope">
    <h2>Scope</h2>
    <p>
      <strong>Question:</strong> How does CS2 dispatch police cars with emergency lights and
      sirens, and what are ALL possible ways a mod can trigger this?
    </p>
    <p>
      <strong>Verdict:</strong> The entire lights-and-sirens behavior is controlled by a single
      flag: <code>CarFlags.Emergency</code> (value <code>0x01</code>) on the <code>Car</code> component.
      There are five distinct code paths to activate it, ranging from creating full event hierarchies
      to directly setting the flag on a vehicle entity. The <strong>recommended approach</strong>
      for mods is direct vehicle manipulation (Path D below), optionally combined with an
      "Emergency Flag Guardian" system to prevent the game's AI from clearing it.
    </p>
    <p>
      <strong>Out of scope:</strong> Police helicopter dispatch (<code>PoliceAircraftAISystem</code>),
      prisoner transport, crime accumulation internals, and patrol route optimization.
    </p>
  </div>

  <!-- ============================================================ -->
  <h2>How It Works</h2>

  <p>
    Police dispatch in CS2 uses the same <strong>request entity pattern</strong> as all other
    emergency services (see <a href="emergency-dispatch.html">Emergency Dispatch</a>). The
    police-specific pipeline adds two critical layers: the <code>AccidentSite</code> validation
    gate (which controls whether police are needed), and the <code>CarFlags.Emergency</code>
    flag (which controls lights, sirens, and driving behavior).
  </p>

  <h3>Two Dispatch Pipelines</h3>

  <p>Police cars serve two distinct roles with different dispatch systems:</p>

  <table>
    <thead>
      <tr><th>Role</th><th>Request Type</th><th>Dispatch System</th><th>Lights/Sirens?</th><th>PoliceCar State</th></tr>
    </thead>
    <tbody>
      <tr>
        <td>Emergency response</td>
        <td><code>PoliceEmergencyRequest</code></td>
        <td><code>PoliceEmergencyDispatchSystem</code></td>
        <td><strong>Yes</strong> -- <code>CarFlags.Emergency</code> set</td>
        <td><code>AccidentTarget</code> flag set</td>
      </tr>
      <tr>
        <td>Patrol</td>
        <td><code>PolicePatrolRequest</code></td>
        <td><code>PolicePatrolDispatchSystem</code></td>
        <td><strong>No</strong> -- <code>CarFlags.Emergency</code> explicitly cleared</td>
        <td>No <code>AccidentTarget</code></td>
      </tr>
    </tbody>
  </table>

  <p><strong>Patrol dispatch CANNOT be leveraged for emergency response.</strong> When
  <code>PoliceCarAISystem.SelectNextDispatch()</code> processes a <code>PolicePatrolRequest</code>,
  it explicitly clears <code>CarFlags.Emergency</code>. The only way to get lights and sirens
  is through <code>PoliceEmergencyRequest</code> or direct flag manipulation.</p>

  <h3>The Emergency Flag: CarFlags.Emergency</h3>

  <p>
    The <code>CarFlags.Emergency</code> flag (value <code>0x01</code>) on the <code>Car</code>
    component is the <strong>single control point</strong> for all emergency behavior:
  </p>

  <ul>
    <li><strong>Emergency lights</strong> -- flashing roof lights activated in the rendering pipeline</li>
    <li><strong>Siren audio</strong> -- emergency siren sound effect plays</li>
    <li><strong>Traffic yielding</strong> -- other vehicles move out of the way</li>
    <li><strong>Lane exemptions</strong> -- can use any lane including oncoming, ignores traffic signals</li>
    <li><strong>Public transport lanes</strong> -- can use bus/tram lanes (combined with <code>UsePublicTransportLanes</code>)</li>
  </ul>

  <p>
    When <code>PoliceCarAISystem.SelectNextDispatch()</code> selects an emergency request, it sets:
  </p>

  <pre><code class="language-csharp">// Emergency dispatch -- lights and sirens ON
car.m_Flags &amp;= ~CarFlags.AnyLaneTarget;
car.m_Flags |= CarFlags.Emergency | CarFlags.StayOnRoad | CarFlags.UsePublicTransportLanes;</code></pre>

  <p>
    When it selects a patrol request, it clears the flag:
  </p>

  <pre><code class="language-csharp">// Patrol dispatch -- lights and sirens OFF
car.m_Flags &amp;= ~CarFlags.Emergency;
car.m_Flags |= CarFlags.StayOnRoad | CarFlags.AnyLaneTarget | CarFlags.UsePublicTransportLanes;</code></pre>

  <p>
    After any flag change, the system adds an <code>EffectsUpdated</code> tag component to the
    vehicle entity, which triggers the rendering pipeline to recalculate visual and audio
    effects on the next frame. Without <code>EffectsUpdated</code>, the flag change takes effect
    for navigation/yielding but the visual lights and audio may not update immediately.
  </p>

  <p>
    The <code>CarFlags.Warning</code> flag (value <code>0x08</code>) activates amber/warning lights
    without full emergency sirens -- used by utility vehicles like garbage trucks.
  </p>

  <!-- ============================================================ -->
  <h2>Five Dispatch Paths</h2>

  <h3>Path A: Crime Event (Game Pipeline)</h3>

  <ol>
    <li><code>CrimeAccumulationSystem</code> detects crime threshold exceeded on building, creates crime event entity, adds <code>AccidentSite</code> with <code>CrimeScene</code> flag</li>
    <li><code>AccidentSiteSystem</code> (every 64 frames): clears <code>RequirePolice</code> unconditionally, then re-evaluates -- if <code>CrimeDetected</code> flag set (after alarm delay), sets <code>RequirePolice</code> and calls <code>RequestPoliceIfNeeded()</code></li>
    <li><code>ServiceRequestSystem</code> assigns <code>UpdateFrame</code>, removes <code>RequestGroup</code></li>
    <li><code>PoliceEmergencyDispatchSystem</code>: validates site, pathfinds from <code>PolicePatrol</code> origin to <code>AccidentLocation</code> destination</li>
    <li><code>PoliceCarAISystem.SelectNextDispatch()</code>: sets <code>CarFlags.Emergency</code>, <code>PoliceCarFlags.AccidentTarget</code>, adds <code>EffectsUpdated</code> -- SIREN + LIGHTS ACTIVATE</li>
    <li>Car drives with emergency privileges, arrives within 30m, secures site</li>
  </ol>

  <h3>Path B: Traffic Accident (Game Pipeline)</h3>

  <p>Same as Path A, but triggered by <code>InvolvedInAccident</code> severity instead of <code>Criminal</code> entities. <code>AddAccidentSiteSystem</code> creates the <code>TrafficAccident</code> event.</p>

  <h3>Path C: Request Pipeline (Mod-Created -- Unreliable)</h3>

  <div class="warning">
    <p>
      <strong>Warning -- Unreliable for mod-created requests.</strong> The request pipeline often
      silently fails for synthetically created requests due to district resolution failure,
      <code>AccidentSite</code> being cleared/removed by <code>AccidentSiteSystem</code>, and
      routing constraints. See "Why the Request Pipeline Fails" below for details.
    </p>
  </div>

  <p>Create a <code>PoliceEmergencyRequest</code> entity and ensure the target has a valid
  <code>AccidentSite</code> with <code>RequirePolice</code>. The request must survive
  <code>AccidentSiteSystem</code>'s clear-then-evaluate cycle.</p>

  <h3 id="path-d">Path D: Direct Vehicle Manipulation (Incomplete Without ServiceDispatch)</h3>

  <div class="warning">
    <p>
      <strong>Warning:</strong> Setting flags alone is NOT sufficient. When
      <code>PoliceCarAISystem.Tick()</code> detects that the path has been updated, it calls
      <code>ResetPath()</code>, which reads the first <code>ServiceDispatch</code> buffer entry to
      determine what flags to set. If the buffer is empty or does not contain a
      <code>PoliceEmergencyRequest</code>, <code>ResetPath()</code> clears
      <code>CarFlags.Emergency</code> and sets <code>AnyLaneTarget</code> (patrol mode) -- lights
      and sirens turn off immediately after pathfinding completes. You MUST inject a
      <code>ServiceDispatch</code> buffer entry (see Path D2 below).
    </p>
  </div>

  <h3 id="path-d2">Path D2: Direct Manipulation + ServiceDispatch Injection (RECOMMENDED)</h3>

  <p>
    The working approach for direct dispatch. Creates a <code>PoliceEmergencyRequest</code> entity
    and injects it into the vehicle's <code>ServiceDispatch</code> buffer so that
    <code>ResetPath()</code> and <code>SelectNextDispatch()</code> correctly recognize the dispatch
    as an emergency and maintain <code>CarFlags.Emergency</code>.
  </p>

  <ol>
    <li>Create a <code>PoliceEmergencyRequest</code> entity with <code>ServiceRequest</code> component</li>
    <li>Inject it into the vehicle's <code>ServiceDispatch</code> buffer (clear existing entries first)</li>
    <li>Set <code>CarFlags.Emergency</code>, <code>PoliceCarFlags.AccidentTarget</code>, <code>Target</code>, trigger path recalculation and <code>EffectsUpdated</code></li>
    <li><code>ResetPath()</code> reads <code>ServiceDispatch[0]</code>, finds <code>PoliceEmergencyRequest</code>, maintains <code>CarFlags.Emergency</code></li>
    <li>Clean up the request entity when dispatch is complete</li>
  </ol>

  <h3>Path E: Fake Crime Event (Alternative)</h3>

  <p>
    Create a complete event entity hierarchy with <code>Criminal</code> or <code>InvolvedInAccident</code>
    components that satisfy <code>AccidentSiteSystem</code>'s validation. The system then naturally
    maintains <code>RequirePolice</code> and the full dispatch pipeline works. More complex than
    Path D but uses the game's official pipeline.
  </p>

  <!-- ============================================================ -->
  <h2>Why the Request Pipeline Fails for Mods</h2>

  <p>The core problem is <code>FindVehicleSource()</code> in <code>PoliceEmergencyDispatchSystem</code>.
  It requires:</p>

  <ol>
    <li>
      <strong>District resolution:</strong> The method calls <code>m_CurrentDistrictData.HasComponent(target)</code>
      first. If the target lacks <code>CurrentDistrict</code>, it falls back to a spatial lookup via
      <code>Transform</code>. If neither exists, the district is <code>Entity.Null</code> and the
      pathfinder's <code>SetupTargetType.PolicePatrol</code> origin finds no matching stations.
    </li>
    <li>
      <strong>AccidentSite cleared by AccidentSiteSystem:</strong> The system unconditionally clears
      <code>RequirePolice</code> every 64 frames, then only re-sets it if valid
      <code>InvolvedInAccident</code> or <code>Criminal</code> entities exist in the event's
      <code>TargetElement</code> buffer. A mod-created <code>AccidentSite</code> without these
      has <code>RequirePolice</code> stripped within 64 frames, causing <code>ValidateSite()</code>
      to fail and the request to be destroyed.
    </li>
    <li>
      <strong>AccidentSite removed entirely:</strong> When the <code>TargetElement</code> buffer
      has zero matching entities and <code>StageAccident</code> is not set,
      <code>AccidentSiteSystem</code> removes the <code>AccidentSite</code> component entirely.
    </li>
    <li>
      <strong>Path routing:</strong> The destination is <code>SetupTargetType.AccidentLocation</code>
      which requires the site entity to be on or near a road network.
    </li>
  </ol>

  <!-- ============================================================ -->
  <h2>The Dispatch Pipeline in Detail</h2>

  <div class="diagram">
<pre>
TRIGGER: Crime event or accident occurs
    |
    v
AccidentSiteSystem (every 64 frames)
    1. Clears RequirePolice unconditionally (line 227)
    2. Iterates TargetElement buffer on m_Event
       - Counts InvolvedInAccident (severity) and Criminal (not arrested)
    3. If severity &gt; 0 OR (unsecured CrimeScene AND CrimeDetected):
       Sets RequirePolice, calls RequestPoliceIfNeeded()
    4. If num == 0 AND not staging: REMOVES AccidentSite entirely
    |
    v
REQUEST ENTITY CREATION
    Creates entity: ServiceRequest + PoliceEmergencyRequest + RequestGroup(4)
      m_Site = AccidentSite entity
      m_Target = highest-severity non-moving target entity
      m_Priority = severity (or 1.0 for crime)
      m_Purpose = CrimeMonitored ? Intelligence : Emergency
    |
    v
ServiceRequestSystem
    Sees RequestGroup(4), assigns random UpdateFrame index (0-3)
    Removes RequestGroup -- request is now scheduled
    |
    v
PoliceEmergencyDispatchSystem (every 16 frames)
    1. ValidateSite(): AccidentSite has RequirePolice &amp; not Secured?
    2. FindVehicleSource(): district resolution + pathfind
       Origin:  SetupTargetType.PolicePatrol (stations/cars in district)
       Dest:    SetupTargetType.AccidentLocation (30m radius)
       Speed:   111.1 m/s (no speed limit for cost calc)
       Weights: (1, 0, 0, 0) -- distance only
       Rules:   ignores ALL traffic restrictions
    |
    ~~ pathfinding runs asynchronously ~~
    |
    3. DispatchVehicle():
       Resolves PathInformation.m_Origin (ParkedCar -&gt; Owner)
       Adds Dispatched(handler) to request entity
       Adds ServiceDispatch(request) to vehicle/station buffer
    |
    v
PoliceStationAISystem (every 256 frames, offset 128)
    If dispatched to station: SpawnVehicle()
      Creates/unparks police car with AccidentTarget flag
      Copies path from request to vehicle
    |
    v
PoliceCarAISystem (every 16 frames, offset 5)
    CheckServiceDispatches(): validates new dispatch
      Emergency requests PRIORITY over patrol requests
      Existing patrol cancelled (PoliceCarFlags.Cancelled)
    |
    SelectNextDispatch():
      Reads ServiceDispatch buffer, finds PoliceEmergencyRequest
      +-- Sets PoliceCarFlags.AccidentTarget
      IF TryAppendPath succeeds (request has PathElement buffer):
        +-- Sets Car.m_Flags: Emergency | StayOnRoad | UsePublicTransportLanes
        +-- Clears CarFlags.AnyLaneTarget
        +-- Clears CarLaneFlags.EndOfPath
        +-- Sets Target.m_Target = site entity
        +-- Adds EffectsUpdated tag --&gt; SIREN + LIGHTS ACTIVATE
      ELSE (fallthrough -- NO PathElement on request):
        +-- ONLY calls VehicleUtils.SetTarget()
        +-- Emergency flags NOT set (no sirens!)
        +-- EndOfPath NOT cleared (false arrival next tick!)
    |
    v
CarNavigationSystem (every frame)
    Reads CarFlags.Emergency:
      - Other cars yield to this vehicle
      - Can use any lane including oncoming
      - Ignores traffic signals
      - Emergency lights and siren rendered
    |
    v
ARRIVAL (path end reached OR within 30m when blocked)
    PoliceCarAISystem:
      Sets PoliceCarFlags.AtTarget
      StopVehicle(): removes Moving, adds Stopped
      SecureAccidentSite(): sets AccidentSiteFlags.Secured + m_SecuredFrame
    |
    v
COMPLETION
    SelectNextDispatch() or ReturnToStation()
    ReturnToStation(): clears AccidentTarget, sets Returning
    ResetPath(): clears Emergency flag --&gt; SIREN + LIGHTS OFF
</pre>
  </div>

  <h3>Reverse Dispatch: Vehicles Seeking Work</h3>

  <p>
    CS2 uses a <strong>bidirectional dispatch</strong> pattern. In addition to sites requesting
    vehicles (forward), vehicles and stations proactively create <strong>reverse requests</strong>
    (with <code>ServiceRequestFlags.Reversed</code>) to seek targets:
  </p>

  <ul>
    <li>
      <code>PoliceCarAISystem.RequestTargetIfNeeded()</code> -- cars with few active dispatches
      create reverse <code>PoliceEmergencyRequest</code> (interval: every 64 frames, RequestGroup 4)
      or reverse <code>PolicePatrolRequest</code> (interval: every 512 frames, RequestGroup 32).
    </li>
    <li>
      <code>PoliceStationAISystem</code> -- stations with available vehicles create reverse
      requests when they have available capacity.
    </li>
  </ul>

  <!-- ============================================================ -->
  <h2>Emergency vs Patrol: Comparison</h2>

  <table>
    <thead>
      <tr><th>Aspect</th><th>Emergency Dispatch</th><th>Patrol Dispatch</th></tr>
    </thead>
    <tbody>
      <tr><td>Request type</td><td><code>PoliceEmergencyRequest</code></td><td><code>PolicePatrolRequest</code></td></tr>
      <tr><td>Validation</td><td><code>AccidentSite</code> with <code>RequirePolice</code>, not <code>Secured</code></td><td><code>CrimeProducer.m_Crime &gt;= tolerance</code></td></tr>
      <tr><td>Vehicle flags</td><td><code>Emergency | StayOnRoad | UsePublicTransportLanes</code></td><td><code>StayOnRoad | AnyLaneTarget | UsePublicTransportLanes</code></td></tr>
      <tr><td>Lights/sirens</td><td><strong>Yes</strong></td><td><strong>No</strong></td></tr>
      <tr><td>PoliceCar state</td><td><code>AccidentTarget</code> flag set</td><td>No <code>AccidentTarget</code></td></tr>
      <tr><td>Pathfind speed</td><td>111.1 m/s (400 km/h)</td><td>277.8 m/s (1000 km/h)</td></tr>
      <tr><td>Pathfind weights</td><td>(1, 0, 0, 0) -- distance only</td><td>(1, 1, 1, 1) -- all factors</td></tr>
      <tr><td>Pathfind methods</td><td>Road only</td><td>Road + Flying (helicopters)</td></tr>
      <tr><td>Reverse request interval</td><td>64 frames</td><td>512 frames</td></tr>
      <tr><td>Purpose filter</td><td>Emergency | Intelligence</td><td>Patrol</td></tr>
      <tr><td>Car availability</td><td>ShiftEnded OK, requestCount &gt; 1 OK</td><td>Must be Empty, no EstimatedShiftEnd</td></tr>
    </tbody>
  </table>

  <!-- ============================================================ -->
  <h2>Double-Dispatch Prevention</h2>

  <p>The game uses three mechanisms to prevent duplicate dispatches:</p>

  <ol>
    <li>
      <strong><code>AccidentSite.m_PoliceRequest</code>:</strong> Each site tracks its current
      request entity. <code>AccidentSiteSystem.RequestPoliceIfNeeded()</code> only creates a new
      request if the existing one is stale. <code>ValidateSite()</code> updates the field to
      the current request.
    </li>
    <li>
      <strong><code>Dispatched</code> component:</strong> Added to the request once a handler
      is assigned. Subsequent ticks validate the handler via <code>ValidateHandler()</code>
      instead of re-pathfinding.
    </li>
    <li>
      <strong><code>m_TargetRequest</code> on stations/cars:</strong> Each station and car tracks
      its reverse-search request. <code>ValidateReversed()</code> rejects new requests if the
      slot is already occupied.
    </li>
  </ol>

  <!-- ============================================================ -->
  <h2>Key Components</h2>

  <table>
    <thead>
      <tr><th>Assembly</th><th>Namespace</th><th>What's There</th></tr>
    </thead>
    <tbody>
      <tr>
        <td>Game.dll</td>
        <td>Game.Simulation</td>
        <td>PoliceEmergencyDispatchSystem, PolicePatrolDispatchSystem, PoliceCarAISystem, PoliceStationAISystem, AccidentSiteSystem, PoliceEmergencyRequest, PolicePatrolRequest, ServiceRequest, ServiceDispatch, Dispatched, HandleRequest, RequestGroup</td>
      </tr>
      <tr>
        <td>Game.dll</td>
        <td>Game.Vehicles</td>
        <td>PoliceCar (component), PoliceCarFlags, Car, CarFlags, CarCurrentLane, CarLaneFlags (vehicle-side)</td>
      </tr>
      <tr>
        <td>Game.dll</td>
        <td>Game.Buildings</td>
        <td>PoliceStation (component), PoliceStationFlags, CrimeProducer</td>
      </tr>
      <tr>
        <td>Game.dll</td>
        <td>Game.Citizens</td>
        <td>Criminal, CriminalFlags (NOTE: not in Game.Events)</td>
      </tr>
      <tr>
        <td>Game.dll</td>
        <td>Game.Events</td>
        <td>AccidentSite, AccidentSiteFlags, InvolvedInAccident</td>
      </tr>
      <tr>
        <td>Game.dll</td>
        <td>Game.Prefabs</td>
        <td>PoliceCarData, PoliceStationData, PoliceConfigurationData, PolicePurpose, CrimeData, TrafficAccidentData</td>
      </tr>
      <tr>
        <td>Game.dll</td>
        <td>Game.Common</td>
        <td>Target, EffectsUpdated</td>
      </tr>
      <tr>
        <td>Game.dll</td>
        <td>Game.Pathfind</td>
        <td>PathOwner, PathInformation, PathElement, SetupQueueItem, SetupTargetType, PathFlags</td>
      </tr>
    </tbody>
  </table>

  <h3>CarFlags (Game.Vehicles) -- Key Flags</h3>

  <table>
    <thead>
      <tr><th>Flag</th><th>Value</th><th>Description</th></tr>
    </thead>
    <tbody>
      <tr><td><strong>Emergency</strong></td><td><strong>0x01</strong></td><td><strong>THE KEY FLAG. Enables lights, sirens, traffic yielding, lane exemptions.</strong></td></tr>
      <tr><td>StayOnRoad</td><td>0x02</td><td>Prevents using parking/garage lanes</td></tr>
      <tr><td>AnyLaneTarget</td><td>0x04</td><td>Can target any lane position (patrol mode)</td></tr>
      <tr><td>Warning</td><td>0x08</td><td>Amber/warning lights (not full emergency)</td></tr>
      <tr><td>UsePublicTransportLanes</td><td>0x20</td><td>Can use bus/tram lanes</td></tr>
    </tbody>
  </table>

  <h3>PoliceCarFlags (Game.Vehicles)</h3>

  <table>
    <thead>
      <tr><th>Flag</th><th>Value</th><th>Description</th></tr>
    </thead>
    <tbody>
      <tr><td>Returning</td><td>0x01</td><td>Heading back to station</td></tr>
      <tr><td>ShiftEnded</td><td>0x02</td><td>Shift timer expired</td></tr>
      <tr><td>AccidentTarget</td><td>0x04</td><td>Dispatched to emergency/accident site</td></tr>
      <tr><td>AtTarget</td><td>0x08</td><td>Arrived at target location</td></tr>
      <tr><td>Disembarking</td><td>0x10</td><td>Unloading passengers (criminals)</td></tr>
      <tr><td>Cancelled</td><td>0x20</td><td>Patrol preempted by emergency</td></tr>
      <tr><td>Full</td><td>0x40</td><td>Criminal capacity filled</td></tr>
      <tr><td>Empty</td><td>0x80</td><td>No passengers</td></tr>
      <tr><td>EstimatedShiftEnd</td><td>0x100</td><td>Route would exceed shift</td></tr>
      <tr><td>Disabled</td><td>0x200</td><td>Car disabled (no station capacity)</td></tr>
    </tbody>
  </table>

  <h3>PoliceCar (Game.Vehicles)</h3>

  <table>
    <thead>
      <tr><th>Field</th><th>Type</th><th>Description</th></tr>
    </thead>
    <tbody>
      <tr><td>m_TargetRequest</td><td>Entity</td><td>Current reverse-search request</td></tr>
      <tr><td>m_State</td><td>PoliceCarFlags</td><td>Bitfield of state flags</td></tr>
      <tr><td>m_RequestCount</td><td>int</td><td>Accepted service dispatch count</td></tr>
      <tr><td>m_PathElementTime</td><td>float</td><td>Average time per path element</td></tr>
      <tr><td>m_ShiftTime</td><td>uint</td><td>Frames since shift started</td></tr>
      <tr><td>m_EstimatedShift</td><td>uint</td><td>Estimated remaining frames</td></tr>
      <tr><td>m_PurposeMask</td><td>PolicePurpose</td><td>Patrol, Emergency, Intelligence</td></tr>
    </tbody>
  </table>

  <h3>PoliceEmergencyRequest (Game.Simulation)</h3>

  <table>
    <thead>
      <tr><th>Field</th><th>Type</th><th>Description</th></tr>
    </thead>
    <tbody>
      <tr><td>m_Site</td><td>Entity</td><td>AccidentSite entity to respond to</td></tr>
      <tr><td>m_Target</td><td>Entity</td><td>Specific target entity at the site</td></tr>
      <tr><td>m_Priority</td><td>float</td><td>Dispatch priority (higher = more urgent)</td></tr>
      <tr><td>m_Purpose</td><td>PolicePurpose</td><td>Emergency or Intelligence</td></tr>
    </tbody>
  </table>

  <h3>AccidentSite (Game.Events)</h3>

  <table>
    <thead>
      <tr><th>Field</th><th>Type</th><th>Description</th></tr>
    </thead>
    <tbody>
      <tr><td>m_Event</td><td>Entity</td><td>Persistent event entity (must be valid Game.Events.Event)</td></tr>
      <tr><td>m_PoliceRequest</td><td>Entity</td><td>Current police emergency request</td></tr>
      <tr><td>m_Flags</td><td>AccidentSiteFlags</td><td>State flags (RequirePolice, Secured, CrimeScene, etc.)</td></tr>
      <tr><td>m_CreationFrame</td><td>uint</td><td>Frame when created</td></tr>
      <tr><td>m_SecuredFrame</td><td>uint</td><td>Frame when secured by police</td></tr>
    </tbody>
  </table>

  <h3>AccidentSiteFlags (Game.Events)</h3>

  <table>
    <thead>
      <tr><th>Flag</th><th>Value</th><th>Description</th></tr>
    </thead>
    <tbody>
      <tr><td>StageAccident</td><td>0x01</td><td>Staging additional impacts</td></tr>
      <tr><td>Secured</td><td>0x02</td><td>Police have secured the site</td></tr>
      <tr><td>CrimeScene</td><td>0x04</td><td>This is a crime scene</td></tr>
      <tr><td>TrafficAccident</td><td>0x08</td><td>This is a traffic accident</td></tr>
      <tr><td>CrimeFinished</td><td>0x10</td><td>Crime has concluded</td></tr>
      <tr><td>CrimeDetected</td><td>0x20</td><td>Crime detected by citizens/monitoring</td></tr>
      <tr><td>CrimeMonitored</td><td>0x40</td><td>CCTV or similar monitoring</td></tr>
      <tr><td>RequirePolice</td><td>0x80</td><td>Police needed (set each tick by AccidentSiteSystem)</td></tr>
      <tr><td>MovingVehicles</td><td>0x100</td><td>Involved vehicles still moving</td></tr>
    </tbody>
  </table>

  <h3>Criminal (Game.Citizens)</h3>

  <table>
    <thead>
      <tr><th>Field</th><th>Type</th><th>Description</th></tr>
    </thead>
    <tbody>
      <tr><td>m_Event</td><td>Entity</td><td>Crime event entity</td></tr>
      <tr><td>m_JailTime</td><td>ushort</td><td>Jail time in frames</td></tr>
      <tr><td>m_Flags</td><td>CriminalFlags</td><td>Robber(1), Prisoner(2), Planning(4), Preparing(8), Monitored(0x10), Arrested(0x20), Sentenced(0x40)</td></tr>
    </tbody>
  </table>

  <h3>CrimeProducer (Game.Buildings)</h3>

  <table>
    <thead>
      <tr><th>Field</th><th>Type</th><th>Description</th></tr>
    </thead>
    <tbody>
      <tr><td>m_PatrolRequest</td><td>Entity</td><td>Active patrol request for this building</td></tr>
      <tr><td>m_Crime</td><td>float</td><td>Current crime level</td></tr>
      <tr><td>m_DispatchIndex</td><td>byte</td><td>Dispatch ordering index</td></tr>
    </tbody>
  </table>

  <h3>PolicePurpose (Game.Prefabs)</h3>

  <table>
    <thead>
      <tr><th>Flag</th><th>Value</th><th>Description</th></tr>
    </thead>
    <tbody>
      <tr><td>Patrol</td><td>1</td><td>Routine patrol</td></tr>
      <tr><td>Emergency</td><td>2</td><td>Emergency response</td></tr>
      <tr><td>Intelligence</td><td>4</td><td>Intelligence/surveillance</td></tr>
    </tbody>
  </table>

  <!-- ============================================================ -->
  <h2>Examples</h2>

  <h3>Example 1: Activate Emergency Lights on Any Police Car</h3>

  <p>
    The simplest approach: set <code>CarFlags.Emergency</code> directly. This immediately enables
    lights and sirens without going through the dispatch pipeline.
  </p>

  <pre><code class="language-csharp">public void ActivateEmergencyLights(EntityManager em, Entity policeCarEntity)
{
    if (!em.HasComponent&lt;Car&gt;(policeCarEntity)) return;
    if (!em.HasComponent&lt;Game.Vehicles.PoliceCar&gt;(policeCarEntity)) return;

    // Set the Emergency flag on the Car component
    Car car = em.GetComponentData&lt;Car&gt;(policeCarEntity);
    car.m_Flags |= CarFlags.Emergency | CarFlags.StayOnRoad
                 | CarFlags.UsePublicTransportLanes;
    em.SetComponentData(policeCarEntity, car);

    // Tag for rendering update so lights/sirens appear
    if (!em.HasComponent&lt;EffectsUpdated&gt;(policeCarEntity))
    {
        em.AddComponent&lt;EffectsUpdated&gt;(policeCarEntity);
    }
}</code></pre>

  <h3>Example 2: Direct Dispatch with ServiceDispatch Injection (RECOMMENDED)</h3>

  <p>
    The recommended approach for reliably sending a police car to a specific entity with lights
    and sirens. <strong>Critical:</strong> Injects a <code>ServiceDispatch</code> buffer entry so
    that <code>ResetPath()</code> maintains the <code>CarFlags.Emergency</code> flag after path
    recalculation. Without the <code>ServiceDispatch</code> entry, <code>ResetPath()</code> clears
    the Emergency flag and the lights/sirens turn off.
  </p>

  <pre><code class="language-csharp">public partial class ForcePoliceToLocationSystem : GameSystemBase
{
    protected override void OnCreate() { base.OnCreate(); }
    protected override void OnUpdate() { }

    /// &lt;summary&gt;
    /// Send a specific police car to a target entity with lights and sirens.
    /// The targetEntity should be on or near the road network.
    /// &lt;/summary&gt;
    public void SendPoliceCarTo(Entity policeCarEntity, Entity targetEntity)
    {
        // 1. Create a PoliceEmergencyRequest for the ServiceDispatch buffer.
        //    ResetPath() reads ServiceDispatch[0] to decide whether to set
        //    Emergency or patrol flags. Without this, it clears Emergency.
        Entity request = EntityManager.CreateEntity();
        EntityManager.AddComponentData(request, new ServiceRequest());
        EntityManager.AddComponentData(request, new PoliceEmergencyRequest
        {
            m_Site = targetEntity,
            m_Target = targetEntity,
            m_Priority = 1f,
            m_Purpose = PolicePurpose.Emergency
        });

        // 2. Inject request into vehicle's ServiceDispatch buffer
        DynamicBuffer&lt;ServiceDispatch&gt; dispatches =
            EntityManager.GetBuffer&lt;ServiceDispatch&gt;(policeCarEntity);
        dispatches.Clear();
        dispatches.Add(new ServiceDispatch { m_Request = request });

        // 3. Set emergency flags on Car component
        Car car = EntityManager.GetComponentData&lt;Car&gt;(policeCarEntity);
        car.m_Flags |= CarFlags.Emergency | CarFlags.StayOnRoad
                     | CarFlags.UsePublicTransportLanes;
        car.m_Flags &amp;= ~CarFlags.AnyLaneTarget;
        EntityManager.SetComponentData(policeCarEntity, car);

        // 4. Set AccidentTarget state on PoliceCar component
        var policeCar = EntityManager.GetComponentData&lt;Game.Vehicles.PoliceCar&gt;(
            policeCarEntity);
        policeCar.m_State |= PoliceCarFlags.AccidentTarget;
        policeCar.m_State &amp;= ~(PoliceCarFlags.Returning | PoliceCarFlags.AtTarget
                               | PoliceCarFlags.Cancelled);
        EntityManager.SetComponentData(policeCarEntity, policeCar);

        // 5. Set navigation target
        EntityManager.SetComponentData(policeCarEntity, new Target(targetEntity));

        // 6. Request new path calculation
        PathOwner po = EntityManager.GetComponentData&lt;PathOwner&gt;(policeCarEntity);
        po.m_State |= PathFlags.Updated;
        EntityManager.SetComponentData(policeCarEntity, po);

        // 7. Trigger rendering update for lights/sirens
        if (!EntityManager.HasComponent&lt;EffectsUpdated&gt;(policeCarEntity))
        {
            EntityManager.AddComponent&lt;EffectsUpdated&gt;(policeCarEntity);
        }
    }
}</code></pre>

  <h3>Example 3: Emergency Flag Guardian System</h3>

  <p>
    Prevents <code>PoliceCarAISystem</code> from clearing the Emergency flag on mod-controlled
    cars. Add a custom <code>ModControlledEmergency</code> tag to cars you want to keep in
    emergency mode.
  </p>

  <pre><code class="language-csharp">/// &lt;summary&gt;
/// Runs after PoliceCarAISystem to re-apply Emergency flags on mod-controlled cars.
/// &lt;/summary&gt;
[UpdateAfter(typeof(PoliceCarAISystem))]
public partial class EmergencyFlagGuardianSystem : GameSystemBase
{
    public struct ModControlledEmergency : IComponentData { }

    private EntityQuery m_ModCarQuery;

    protected override void OnCreate()
    {
        base.OnCreate();
        m_ModCarQuery = GetEntityQuery(
            ComponentType.ReadOnly&lt;ModControlledEmergency&gt;(),
            ComponentType.ReadWrite&lt;Car&gt;(),
            ComponentType.Exclude&lt;Deleted&gt;()
        );
        RequireForUpdate(m_ModCarQuery);
    }

    protected override void OnUpdate()
    {
        var entities = m_ModCarQuery.ToEntityArray(Allocator.Temp);
        for (int i = 0; i &lt; entities.Length; i++)
        {
            Car car = EntityManager.GetComponentData&lt;Car&gt;(entities[i]);
            if ((car.m_Flags &amp; CarFlags.Emergency) == 0)
            {
                car.m_Flags |= CarFlags.Emergency | CarFlags.StayOnRoad
                             | CarFlags.UsePublicTransportLanes;
                car.m_Flags &amp;= ~CarFlags.AnyLaneTarget;
                EntityManager.SetComponentData(entities[i], car);
                if (!EntityManager.HasComponent&lt;EffectsUpdated&gt;(entities[i]))
                {
                    EntityManager.AddComponent&lt;EffectsUpdated&gt;(entities[i]);
                }
            }
        }
        entities.Dispose();
    }
}</code></pre>

  <h3>Example 4: Find Available Police Cars</h3>

  <pre><code class="language-csharp">public partial class FindAvailablePoliceCarsSystem : GameSystemBase
{
    private EntityQuery m_PoliceCarQuery;

    protected override void OnCreate()
    {
        base.OnCreate();
        m_PoliceCarQuery = GetEntityQuery(
            ComponentType.ReadOnly&lt;Game.Vehicles.PoliceCar&gt;(),
            ComponentType.ReadOnly&lt;Car&gt;(),
            ComponentType.ReadOnly&lt;Target&gt;(),
            ComponentType.Exclude&lt;Deleted&gt;(),
            ComponentType.Exclude&lt;Temp&gt;()
        );
    }

    protected override void OnUpdate() { }

    public NativeList&lt;Entity&gt; GetAvailablePoliceCars(Allocator allocator)
    {
        var result = new NativeList&lt;Entity&gt;(allocator);
        var entities = m_PoliceCarQuery.ToEntityArray(Allocator.Temp);
        for (int i = 0; i &lt; entities.Length; i++)
        {
            var pc = EntityManager.GetComponentData&lt;Game.Vehicles.PoliceCar&gt;(
                entities[i]);
            PoliceCarFlags busyFlags = PoliceCarFlags.Returning
                                     | PoliceCarFlags.AtTarget
                                     | PoliceCarFlags.ShiftEnded
                                     | PoliceCarFlags.Disabled;
            if ((pc.m_State &amp; busyFlags) == 0 &amp;&amp; pc.m_RequestCount &lt;= 1)
            {
                result.Add(entities[i]);
            }
        }
        entities.Dispose();
        return result;
    }
}</code></pre>

  <h3>Example 5: Complete Dispatch-and-Guard System</h3>

  <p>
    The most robust approach: finds an available car, sets emergency flags, tracks it with a
    <code>ModDispatched</code> tag, and guards against the AI clearing the flags.
  </p>

  <pre><code class="language-csharp">[UpdateAfter(typeof(PoliceCarAISystem))]
public partial class RobustPoliceDispatchSystem : GameSystemBase
{
    public struct ModDispatched : IComponentData
    {
        public Entity m_Target;
    }

    private EntityQuery m_PoliceCarQuery;
    private EntityQuery m_ModDispatchedQuery;

    protected override void OnCreate()
    {
        base.OnCreate();
        m_PoliceCarQuery = GetEntityQuery(
            ComponentType.ReadOnly&lt;Game.Vehicles.PoliceCar&gt;(),
            ComponentType.ReadOnly&lt;Car&gt;(),
            ComponentType.ReadOnly&lt;Target&gt;(),
            ComponentType.Exclude&lt;Deleted&gt;(),
            ComponentType.Exclude&lt;Temp&gt;()
        );
        m_ModDispatchedQuery = GetEntityQuery(
            ComponentType.ReadOnly&lt;ModDispatched&gt;(),
            ComponentType.ReadWrite&lt;Car&gt;(),
            ComponentType.Exclude&lt;Deleted&gt;()
        );
    }

    protected override void OnUpdate()
    {
        // Guardian: re-apply Emergency on mod-dispatched cars
        var modCars = m_ModDispatchedQuery.ToEntityArray(Allocator.Temp);
        for (int i = 0; i &lt; modCars.Length; i++)
        {
            ModDispatched md = EntityManager.GetComponentData&lt;ModDispatched&gt;(
                modCars[i]);
            Target target = EntityManager.GetComponentData&lt;Target&gt;(modCars[i]);

            // Re-set target if AI changed it
            if (target.m_Target != md.m_Target &amp;&amp; md.m_Target != Entity.Null
                &amp;&amp; EntityManager.Exists(md.m_Target))
            {
                EntityManager.SetComponentData(modCars[i],
                    new Target(md.m_Target));
            }

            Car car = EntityManager.GetComponentData&lt;Car&gt;(modCars[i]);
            if ((car.m_Flags &amp; CarFlags.Emergency) == 0)
            {
                car.m_Flags |= CarFlags.Emergency | CarFlags.StayOnRoad
                             | CarFlags.UsePublicTransportLanes;
                car.m_Flags &amp;= ~CarFlags.AnyLaneTarget;
                EntityManager.SetComponentData(modCars[i], car);
                if (!EntityManager.HasComponent&lt;EffectsUpdated&gt;(modCars[i]))
                {
                    EntityManager.AddComponent&lt;EffectsUpdated&gt;(modCars[i]);
                }
            }

            // Release car when it arrives
            var pc = EntityManager.GetComponentData&lt;Game.Vehicles.PoliceCar&gt;(
                modCars[i]);
            if ((pc.m_State &amp; PoliceCarFlags.AtTarget) != 0)
            {
                EntityManager.RemoveComponent&lt;ModDispatched&gt;(modCars[i]);
            }
        }
        modCars.Dispose();
    }

    /// &lt;summary&gt;
    /// Find nearest available car and dispatch with sirens.
    /// Returns Entity.Null if none available.
    /// &lt;/summary&gt;
    public Entity DispatchNearestTo(Entity targetEntity)
    {
        var entities = m_PoliceCarQuery.ToEntityArray(Allocator.Temp);
        Entity bestCar = Entity.Null;

        for (int i = 0; i &lt; entities.Length; i++)
        {
            var pc = EntityManager.GetComponentData&lt;Game.Vehicles.PoliceCar&gt;(
                entities[i]);
            if ((pc.m_State &amp; (PoliceCarFlags.Returning | PoliceCarFlags.AtTarget
                | PoliceCarFlags.ShiftEnded | PoliceCarFlags.Disabled)) != 0)
                continue;
            if (pc.m_RequestCount &gt; 1) continue;
            if (EntityManager.HasComponent&lt;ModDispatched&gt;(entities[i])) continue;
            bestCar = entities[i];
            break;
        }
        entities.Dispose();
        if (bestCar == Entity.Null) return Entity.Null;

        // Create PoliceEmergencyRequest for ServiceDispatch buffer
        Entity request = EntityManager.CreateEntity();
        EntityManager.AddComponentData(request, new ServiceRequest());
        EntityManager.AddComponentData(request, new PoliceEmergencyRequest
        {
            m_Site = targetEntity,
            m_Target = targetEntity,
            m_Priority = 1f,
            m_Purpose = PolicePurpose.Emergency
        });

        // Inject into ServiceDispatch buffer (required for ResetPath)
        DynamicBuffer&lt;ServiceDispatch&gt; dispatches =
            EntityManager.GetBuffer&lt;ServiceDispatch&gt;(bestCar);
        dispatches.Clear();
        dispatches.Add(new ServiceDispatch { m_Request = request });

        // Set emergency flags
        Car car = EntityManager.GetComponentData&lt;Car&gt;(bestCar);
        car.m_Flags |= CarFlags.Emergency | CarFlags.StayOnRoad
                     | CarFlags.UsePublicTransportLanes;
        car.m_Flags &amp;= ~CarFlags.AnyLaneTarget;
        EntityManager.SetComponentData(bestCar, car);

        // Set PoliceCar state
        var policeCar = EntityManager.GetComponentData&lt;Game.Vehicles.PoliceCar&gt;(
            bestCar);
        policeCar.m_State |= PoliceCarFlags.AccidentTarget;
        policeCar.m_State &amp;= ~(PoliceCarFlags.Returning | PoliceCarFlags.AtTarget
                               | PoliceCarFlags.Cancelled);
        EntityManager.SetComponentData(bestCar, policeCar);

        // Set target, request path, trigger effects
        EntityManager.SetComponentData(bestCar, new Target(targetEntity));
        PathOwner po = EntityManager.GetComponentData&lt;PathOwner&gt;(bestCar);
        po.m_State |= PathFlags.Updated;
        EntityManager.SetComponentData(bestCar, po);
        if (!EntityManager.HasComponent&lt;EffectsUpdated&gt;(bestCar))
            EntityManager.AddComponent&lt;EffectsUpdated&gt;(bestCar);

        // Tag for guardian tracking
        EntityManager.AddComponentData(bestCar, new ModDispatched
        {
            m_Target = targetEntity
        });
        return bestCar;
    }
}</code></pre>

  <h3>Example 6: Full Pipeline Dispatch with Fake Event</h3>

  <div class="warning">
    <p>
      <strong>Warning:</strong> This approach requires careful lifecycle management. The mod must
      clean up the event entity, AccidentSite, and InvolvedInAccident components when done.
      Consider using <a href="#path-d">Path D (direct manipulation)</a> instead.
    </p>
  </div>

  <pre><code class="language-csharp">[UpdateAfter(typeof(AccidentSiteSystem))]
public partial class FullPipelinePoliceDispatchSystem : GameSystemBase
{
    private SimulationSystem m_SimulationSystem;
    private Entity m_EventEntity;
    private Entity m_DummyEntity;

    protected override void OnCreate()
    {
        base.OnCreate();
        m_SimulationSystem = World.GetOrCreateSystemManaged&lt;SimulationSystem&gt;();
    }

    protected override void OnUpdate() { }
    protected override void OnDestroy() { CleanUp(); base.OnDestroy(); }

    /// &lt;summary&gt;
    /// Dispatch police via full pipeline. Target must be on road network.
    /// &lt;/summary&gt;
    public void DispatchTo(Entity targetEntity)
    {
        CleanUp();
        uint frame = m_SimulationSystem.frameIndex;

        // 1. Create event entity with TargetElement buffer
        m_EventEntity = EntityManager.CreateEntity();
        EntityManager.AddComponentData&lt;Game.Events.Event&gt;(m_EventEntity, default);
        var buf = EntityManager.AddBuffer&lt;TargetElement&gt;(m_EventEntity);

        // 2. Create dummy with InvolvedInAccident (severity &gt; 0, not moving)
        m_DummyEntity = EntityManager.CreateEntity();
        EntityManager.AddComponentData(m_DummyEntity, new InvolvedInAccident
        {
            m_Event = m_EventEntity,
            m_Severity = 1f,
            m_InvolvedFrame = frame
        });
        buf.Add(new TargetElement { m_Entity = m_DummyEntity });

        // 3. Add AccidentSite to target
        if (!EntityManager.HasComponent&lt;AccidentSite&gt;(targetEntity))
        {
            EntityManager.AddComponentData(targetEntity, new AccidentSite
            {
                m_Event = m_EventEntity,
                m_Flags = AccidentSiteFlags.TrafficAccident
                        | AccidentSiteFlags.RequirePolice,
                m_PoliceRequest = Entity.Null,
                m_CreationFrame = frame
            });
        }

        // 4. Create emergency request
        Entity request = EntityManager.CreateEntity();
        EntityManager.AddComponentData(request, new ServiceRequest());
        EntityManager.AddComponentData(request, new PoliceEmergencyRequest(
            targetEntity, targetEntity, 1f, PolicePurpose.Emergency));
        EntityManager.AddComponentData(request, new RequestGroup(4u));
    }

    public void CleanUp()
    {
        if (m_EventEntity != Entity.Null &amp;&amp; EntityManager.Exists(m_EventEntity))
        {
            EntityManager.DestroyEntity(m_EventEntity);
            m_EventEntity = Entity.Null;
        }
        if (m_DummyEntity != Entity.Null &amp;&amp; EntityManager.Exists(m_DummyEntity))
        {
            EntityManager.DestroyEntity(m_DummyEntity);
            m_DummyEntity = Entity.Null;
        }
    }
}</code></pre>

  <h3>Example 7: Monitor Police Emergency Response</h3>

  <pre><code class="language-csharp">public partial class PoliceResponseMonitorSystem : GameSystemBase
{
    private EntityQuery m_PoliceQuery;

    protected override void OnCreate()
    {
        base.OnCreate();
        m_PoliceQuery = GetEntityQuery(
            ComponentType.ReadOnly&lt;Game.Vehicles.PoliceCar&gt;(),
            ComponentType.ReadOnly&lt;Car&gt;(),
            ComponentType.ReadOnly&lt;Target&gt;(),
            ComponentType.Exclude&lt;Deleted&gt;()
        );
    }

    protected override void OnUpdate()
    {
        var entities = m_PoliceQuery.ToEntityArray(Allocator.Temp);
        int emergencyCount = 0;
        int patrolCount = 0;
        int returningCount = 0;

        for (int i = 0; i &lt; entities.Length; i++)
        {
            Car car = EntityManager.GetComponentData&lt;Car&gt;(entities[i]);
            var pc = EntityManager.GetComponentData&lt;Game.Vehicles.PoliceCar&gt;(
                entities[i]);

            if ((car.m_Flags &amp; CarFlags.Emergency) != 0)
                emergencyCount++;
            else if ((pc.m_State &amp; PoliceCarFlags.Returning) != 0)
                returningCount++;
            else
                patrolCount++;
        }

        if (emergencyCount &gt; 0)
        {
            Log.Info($"Police: {emergencyCount} emergency, " +
                     $"{patrolCount} patrol, {returningCount} returning");
        }
        entities.Dispose();
    }
}</code></pre>

  <!-- ============================================================ -->
  <h2>Configuration</h2>

  <table>
    <thead>
      <tr><th>Parameter</th><th>Source</th><th>Default</th><th>Effect</th></tr>
    </thead>
    <tbody>
      <tr>
        <td>Criminal capacity</td>
        <td>PoliceCarData.m_CriminalCapacity</td>
        <td>2</td>
        <td>Max criminals per car</td>
      </tr>
      <tr>
        <td>Crime reduction rate</td>
        <td>PoliceCarData.m_CrimeReductionRate</td>
        <td>10000</td>
        <td>Crime reduced per patrol visit</td>
      </tr>
      <tr>
        <td>Shift duration</td>
        <td>PoliceCarData.m_ShiftDuration</td>
        <td>262144 frames</td>
        <td>How long before car returns to station</td>
      </tr>
      <tr>
        <td>Patrol car capacity</td>
        <td>PoliceStationData.m_PatrolCarCapacity</td>
        <td>10</td>
        <td>Cars per station</td>
      </tr>
      <tr>
        <td>Helicopter capacity</td>
        <td>PoliceStationData.m_PoliceHelicopterCapacity</td>
        <td>0</td>
        <td>Helicopters per station</td>
      </tr>
      <tr>
        <td>Jail capacity</td>
        <td>PoliceStationData.m_JailCapacity</td>
        <td>15</td>
        <td>Prisoners per station</td>
      </tr>
      <tr>
        <td>Crime tolerance</td>
        <td>PoliceConfigurationData.m_CrimeAccumulationTolerance</td>
        <td>Singleton prefab</td>
        <td>Threshold before patrol dispatch triggers</td>
      </tr>
      <tr>
        <td>Emergency dispatch interval</td>
        <td>Hardcoded</td>
        <td>16 frames</td>
        <td>How often dispatch systems run</td>
      </tr>
      <tr>
        <td>AccidentSite eval interval</td>
        <td>Hardcoded</td>
        <td>64 frames</td>
        <td>How often RequirePolice is re-evaluated</td>
      </tr>
      <tr>
        <td>Station AI interval</td>
        <td>Hardcoded</td>
        <td>256 frames, offset 128</td>
        <td>How often stations evaluate vehicles</td>
      </tr>
      <tr>
        <td>Emergency pathfind speed</td>
        <td>Hardcoded</td>
        <td>111.1 m/s (400 km/h)</td>
        <td>Speed for pathfinding cost (not actual speed)</td>
      </tr>
      <tr>
        <td>Patrol pathfind speed</td>
        <td>Hardcoded</td>
        <td>277.8 m/s (1000 km/h)</td>
        <td>Higher because patrol considers all weight factors</td>
      </tr>
      <tr>
        <td>Arrival distance</td>
        <td>Hardcoded</td>
        <td>30m</td>
        <td>How close the car must be to consider itself at target</td>
      </tr>
      <tr>
        <td>Staging timeout</td>
        <td>Hardcoded</td>
        <td>3600 frames (~60s)</td>
        <td>How long AccidentSite can stage additional impacts</td>
      </tr>
      <tr>
        <td>Secured cleanup</td>
        <td>Hardcoded</td>
        <td>1024 frames after secured</td>
        <td>How long after securing before AccidentSite is removed</td>
      </tr>
    </tbody>
  </table>

  <!-- ============================================================ -->
  <h2>Open Questions</h2>

  <ul>
    <li>
      <strong>Rendering pipeline for emergency effects:</strong> The <code>EffectsUpdated</code>
      tag triggers effect recalculation, and <code>CarFlags.Emergency</code> is checked to
      enable emergency lights/siren. The specific rendering system that converts this flag to
      actual siren mesh animation and audio is deep in the rendering pipeline and not accessible
      via Game.dll decompilation. The flag is sufficient for a mod -- rendering follows automatically.
    </li>
    <li>
      <strong>Traffic yielding mechanics:</strong> How exactly does <code>CarNavigationSystem</code>
      make other vehicles yield to emergency vehicles? Likely in <code>CarNavigationHelpers.LaneReservation</code>
      but the exact interaction is not traced.
    </li>
  </ul>

  <!-- ============================================================ -->
  <h2>Sources</h2>

  <ul>
    <li>Decompiled (full systems): Game.Simulation.PoliceCarAISystem, Game.Simulation.PoliceEmergencyDispatchSystem, Game.Simulation.PolicePatrolDispatchSystem, Game.Simulation.PoliceStationAISystem, Game.Simulation.AccidentSiteSystem</li>
    <li>Decompiled (components): Game.Vehicles.PoliceCar, Car, PoliceCarFlags, CarFlags, CarCurrentLane, CarLaneFlags; Game.Net.CarLaneFlags; Game.Buildings.PoliceStation, CrimeProducer; Game.Citizens.Criminal, CriminalFlags; Game.Events.AccidentSite, AccidentSiteFlags; Game.Simulation.PoliceEmergencyRequest, PolicePatrolRequest, ServiceRequest, Dispatched</li>
    <li>Prefab data: PoliceCarData, PoliceStationData, PoliceConfigurationData, PolicePurpose</li>
    <li>Related: <a href="emergency-dispatch.html">Emergency Dispatch</a> (general dispatch framework), <a href="crime-trigger.html">Crime Trigger</a> (what triggers police)</li>
  </ul>

  <footer>
    <p>Source: Decompiled from Game.dll (Cities: Skylines II) using ilspycmd v9.1. Game version as of 2026-02-16.</p>
    <div class="attribution-footer">
      <p>This documentation was generated using Claude (Anthropic), supervised by the repository owner.</p>
    </div>
  </footer>

  </main>

</div>

</body>
</html>
